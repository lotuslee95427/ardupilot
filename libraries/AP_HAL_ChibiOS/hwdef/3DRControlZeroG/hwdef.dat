# 这是3DR Control Zero OEM H7飞控板的硬件定义文件
# 该文件定义了飞控板的硬件配置,包括MCU、引脚分配、外设等

# MCU类型和具体型号
# 使用STM32H7系列的STM32H743处理器
MCU STM32H7xx STM32H743xx

# 开发板ID,用于固件校验
APJ_BOARD_ID 1124

# 晶振配置
OSCILLATOR_HZ 24000000  # 外部晶振频率为24MHz
define STM32_HSE_BYPASS # 启用HSE旁路模式
define SMPS_EXT         # 使用外部开关电源

# Flash存储配置
FLASH_SIZE_KB 2048     # Flash总大小为2MB

# 由于Flash容量充足,可以优化速度
env OPTIMIZE -O2

# 从第2个扇区开始(第1个扇区用于bootloader)
FLASH_RESERVE_START_KB 128

# 定义存储区大小为32KB
define HAL_STORAGE_SIZE 32768

# USB设备配置
# 设置USB供应商ID和产品ID
USB_VENDOR 0x26ac
USB_PRODUCT 0x1124
USB_STRING_MANUFACTURER "3DR"  # USB制造商字符串
USB_STRING_PRODUCT "CZOEMrevG" # USB产品名称字符串

# MCO时钟输出引脚
PA8 RCC_MCO_1 OUTPUT LOW

# 核心电压使能引脚
PH5 VDD_1V2_CORE_EN OUTPUT HIGH

# RC输入配置为中断模式而非DMA模式
PC7 TIM3_CH2 TIM3 RCININT PULLDOWN LOW

# GPIO(70) 同时也是USART6_RX用于串行RC

# Spektrum遥控器电源控制
PE4 SPEKTRUM_PWR OUTPUT LOW GPIO(70)
define HAL_GPIO_SPEKTRUM_PWR 70

# Spektrum电源为高电平有效
define HAL_SPEKTRUM_PWR_ENABLED 0

# Spektrum RC输入引脚,用作GPIO绑定卫星接收机
PB0 SPEKTRUM_RC INPUT PULLUP GPIO(71)
define HAL_GPIO_SPEKTRUM_RC 71

# I2C总线顺序
I2C_ORDER I2C1 I2C3 I2C4

# 该板没有内部I2C总线,标记所有总线为外部
define HAL_I2C_INTERNAL_MASK 0

# UART顺序和建议用途:
# USART2 - TELEM1(数传1)
# USART3 - TELEM2(数传2)
# UART4 - GPS1
# UART8 - GPS2
# UART7 - DEBUG(调试)
# USART6 - RC输入(仅RX引脚连接)
# OTG1/2 - USB设备(1个物理USB接口枚举为2个逻辑端口)

SERIAL_ORDER OTG1 USART2 USART3 UART4 UART8 UART7 USART6 OTG2

# USART2配置(数传1),带RTS/CTS流控
PD5 USART2_TX USART2
PD6 USART2_RX USART2
PD3 USART2_CTS USART2
PD4 USART2_RTS USART2

# USART3配置(数传2),带RTS/CTS流控
PD8 USART3_TX USART3
PD9 USART3_RX USART3
PD11 USART3_CTS USART3
PD12 USART3_RTS USART3

# UART4配置(GPS1)
PA0 UART4_TX UART4
PA1 UART4_RX UART4

# UART7配置(调试),禁用DMA
PE8 UART7_TX UART7 NODMA
PE7 UART7_RX UART7 NODMA

# USART6配置
PG14 USART6_TX USART6
PG9  USART6_RX USART6
PG13 USART6_CTS USART6
PG12 USART6_RTS USART6

# UART8配置(GPS2)
PE1 UART8_TX UART8
PE0 UART8_RX UART8

# RSSI模拟输入
PC1 RSSI_IN ADC1

# 安全开关输入
PC4 SAFETY_IN INPUT PULLDOWN
define HAL_HAVE_SAFETY_SWITCH 1

# 电池电压电流检测引脚
PA2 BATT_VOLTAGE_SENS ADC1 SCALE(1)
PA3 BATT_CURRENT_SENS ADC1 SCALE(1)

# VDD电压检测引脚,用于检测主板电压
PA4 VDD_5V_SENS ADC1 SCALE(2)

# 设置默认电池引脚和电压电流比例(针对Power Zero - M10077调整)
define HAL_BATT_VOLT_PIN 14
define HAL_BATT_CURR_PIN 15
define HAL_BATT_VOLT_SCALE 15.3
define HAL_BATT_CURR_SCALE 50.0

# SPI1配置(用于ICM20602/ICM20948)
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1

# SPI2配置(用于FRAM/DPS310)
PB10 SPI2_SCK SPI2
PB14 SPI2_MISO SPI2
PB15 SPI2_MOSI SPI2

# SPI5配置(用于BMI088)
PF7 SPI5_SCK SPI5
PF8 SPI5_MISO SPI5
PF9 SPI5_MOSI SPI5

# SPI6配置(外部接口,已注释)
#PG13 SPI6_SCK SPI6
#PG12 SPI6_MISO SPI6
#PG14 SPI6_MOSI SPI6

# USB检测引脚,开漏输入
PA9 VBUS INPUT OPENDRAIN

# USB电源有效检测引脚
PC0 VBUS_VALID INPUT PULLDOWN

# USB数据引脚
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# SWD调试接口引脚
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# 蜂鸣器PWM输出
PA15 TIM2_CH1 TIM2 GPIO(77) ALARM

# I2C1总线
PB8 I2C1_SCL I2C1
PB9 I2C1_SDA I2C1

# I2C3总线
PH7 I2C3_SCL I2C3
PH8 I2C3_SDA I2C3

# I2C4总线
PB6 I2C4_SCL I2C4
PB7 I2C4_SDA I2C4

# microSD卡接口
PC8 SDMMC1_D0 SDMMC1
PC9 SDMMC1_D1 SDMMC1
PC10 SDMMC1_D2 SDMMC1
PC11 SDMMC1_D3 SDMMC1
PC12 SDMMC1_CK SDMMC1
PD2 SDMMC1_CMD SDMMC1

# SPI传感器的片选引脚
PC2 ICM_20602_CS CS
PD7 BARO_CS CS
PD10 FRAM_CS CS SPEED_VERYLOW NODMA
PE15 ICM_20948_CS CS
PF6 BMI088_ACCEL_CS CS
PF10 BMI088_GYRO_CS CS
#PG9 EXTERNAL CS

# CAN总线接口
PD0 CAN1_RX CAN1
PD1 CAN1_TX CAN1

PB13 CAN2_TX CAN2
PB12 CAN2_RX CAN2

# CAN静音引脚,低电平使能
PF5 GPIO_CAN_SILENT OUTPUT PUSHPULL SPEED_LOW LOW GPIO(72)

# PWM输出引脚配置
# 这些引脚可以配置为PWM输出或GPIO
# 为了与HAL_PX4兼容,GPIO编号从50开始
PE14 TIM1_CH4 TIM1 PWM(1) GPIO(50) BIDIR
PE13 TIM1_CH3 TIM1 PWM(2) GPIO(51)
PE11 TIM1_CH2 TIM1 PWM(3) GPIO(52) BIDIR
PE9  TIM1_CH1 TIM1 PWM(4) GPIO(53)
PD13 TIM4_CH2 TIM4 PWM(5) GPIO(54) BIDIR
PD14 TIM4_CH3 TIM4 PWM(6) GPIO(55) BIDIR
PI5  TIM8_CH1 TIM8 PWM(7) GPIO(56) BIDIR
PI6  TIM8_CH2 TIM8 PWM(8) GPIO(57)

# ICM20602数据就绪引脚
PD15 MPU_DRDY INPUT

# 电源使能引脚
PE3 VDD_1V8_3V3_SENSORS_EN OUTPUT HIGH  # 传感器1.8V/3.3V电源使能
PC5 VDD_3V3_PERIPH_EN OUTPUT HIGH       # 外设3.3V电源使能

# 电源状态检测引脚
PB5 VDD_BRICK_VALID INPUT PULLDOWN

# SPI设备配置
SPIDEV dps310      SPI2 DEVID3  BARO_CS           MODE3  5*MHZ  5*MHZ
SPIDEV ramtron     SPI2 DEVID10 FRAM_CS           MODE3  8*MHZ  8*MHZ
SPIDEV bmi088_g    SPI5 DEVID1  BMI088_GYRO_CS    MODE3  10*MHZ  10*MHZ
SPIDEV bmi088_a    SPI5 DEVID2  BMI088_ACCEL_CS   MODE3  10*MHZ  10*MHZ
SPIDEV icm20608    SPI1 DEVID2  ICM_20602_CS      MODE3  2*MHZ  7*MHZ
SPIDEV icm20948    SPI1 DEVID1  ICM_20948_CS      MODE3  2*MHZ  7*MHZ

# 启用RAMTRON参数存储
define HAL_WITH_RAMTRON 1

# 启用FAT文件系统支持(需要SDMMC定义的microSD)
define HAL_OS_FATFS_IO 1

# 启用三色LED支持
define AP_NOTIFY_GPIO_LED_RGB_ENABLED 1

# LED引脚配置
PB11 LED_R OUTPUT HIGH GPIO(0)
PB1  LED_G OUTPUT HIGH GPIO(1)
PB3  LED_B OUTPUT HIGH GPIO(2)

# 定义RGB LED引脚
define AP_NOTIFY_GPIO_LED_RGB_RED_PIN 0
define AP_NOTIFY_GPIO_LED_RGB_GREEN_PIN 1
define AP_NOTIFY_GPIO_LED_RGB_BLUE_PIN 2

# DMA优先级配置
DMA_NOSHARE SPI1* SPI5*

# IMU配置(3个)
IMU BMI088       SPI:bmi088_a SPI:bmi088_g ROTATION_NONE
IMU Invensense   SPI:icm20608 ROTATION_ROLL_180_YAW_90
IMU Invensensev2 SPI:icm20948 ROTATION_ROLL_180_YAW_90

# 设置默认IMU快速采样
define HAL_DEFAULT_INS_FAST_SAMPLE 7

# 气压计配置(1个)
BARO DPS280      SPI:dps310

# 指南针配置(1个)
COMPASS AK09916:probe_ICM20948 0 ROTATION_ROLL_180
define HAL_PROBE_EXTERNAL_I2C_COMPASSES
